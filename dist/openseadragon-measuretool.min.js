!function(t){"use strict";function e(e){this.rectDone&&this.rect&&(this.rectDone=!1,this.rect=null),this.viewer.setMouseNavEnabled(!1);var i=this.viewer.viewport.deltaPointsFromPixels(e.delta,!0),r=this.viewer.viewport.pointFromPixel(e.position,!0),n=new t.Point(r.x-i.x,r.y-i.y),o=this.viewer.viewport.getRotation();this.startAngle=o,this.rect?(this.rect.width+=i.x,this.rect.height+=i.y,r.x-this.rect.x<0?r.y-this.rect.y<0?(this.quadrant=1,this.switched=!1):(this.quadrant=2,this.switched=!0):r.y-this.rect.y<0?(this.quadrant=0,this.switched=!1):(this.quadrant=3,this.switched=!0)):(this.startRotated?(this.rotatedStartPoint=n,this.rect=a(n,r,this.startRotatedHeight)):this.rect=new t.MeasuretoolRect(n.x,n.y,i.x,i.y),this.rectDone=!1),this.draw()}function i(){this.viewer.setMouseNavEnabled(!0),this.rectDone=!0}function r(){this.viewer.canvas.focus()}function n(e,i){var r=i.delta,n=this.rect.getDegreeRotation(),o=this.viewer.viewport.getRotation();this.startAngle=o;var s;0!==n&&(r=r.rotate(-1*n,new t.Point(0,0)),s=this.rect.getCenter()),r=this.viewer.viewport.deltaPointsFromPixels(r,!0);var a=e;switch(this.switched&&(a=1-a),a){case 0:this.rect.y+=r.y,this.rect.height-=r.y,this.rect.x+=r.x,this.rect.width-=r.x;break;case 1:this.rect.width+=r.x,this.rect.height+=r.y}if(this.rect.width<0?this.rect.height<0?this.quadrant=1:this.quadrant=2:this.rect.height<0?this.quadrant=0:this.quadrant=3,0===e&&(this.quadrant=(this.quadrant+2)%4),0!==n){var h=this.rect.getCenter(),l=h.rotate(n,s);r=l.minus(h),this.rect.x+=r.x,this.rect.y+=r.y}this.draw()}function o(t){0===t?this.switched=0===this.quadrant||1===this.quadrant:1===t&&(this.switched=2===this.quadrant||3===this.quadrant)}function s(t){var e=t.keyCode?t.keyCode:t.charCode;13===e?this.confirm():String.fromCharCode(e)===this.keyboardShortcut&&this.toggleState()}function a(e,i,r){if(e.x>i.x){var n=e;e=i,i=n}var o=i.minus(e),s=e.distanceTo(i),a=-1*Math.atan2(o.x,o.y)+Math.PI/2,h=new t.Point(o.x/2+e.x,o.y/2+e.y),l=new t.MeasuretoolRect(h.x-s/2,h.y-r/2,s,r,a),d=new t.Point(0,r);return d=d.rotate(l.getDegreeRotation(),new t.Point(0,0)),l.x+=d.x/2,l.y+=d.y/2,l}function h(t,e){return t<1e-6?1e9*t+" n"+e:t<1e-5?1e6*t+" μ"+e:t<1?1e3*t+" m"+e:t>=1e3?t/1e3+" k"+e:t+" "+e}function l(t,e,i){if(e<0)return h(t,i);var r=Math.pow(10,e);return t<1e-6?Math.round(r*t*1e9)/r+" n"+i:t<1e-5?Math.round(r*t*1e6)/r+" μ"+i:t<1?Math.round(r*t*1e3)/r+" m"+i:t>=1e3?Math.round(r*t/1e3)/r+" k"+i:Math.round(r*t)/r+" "+i}if(!t.version||t.version.major<2)throw new Error("This version of OpenSeadragonMeasuretool requires OpenSeadragon version 2.0.0+");t.Viewer.prototype.measuretool=function(e){return this.measuretoolInstance&&!e||(e=e||{},e.viewer=this,this.measuretoolInstance=new t.Measuretool(e)),this.measuretoolInstance},t.Measuretool=function(a){if(t.extend(!0,this,{viewer:null,isMeasuring:!1,buttonActiveImg:!1,rectDone:!0,quadrant:0,switched:!1,element:null,pixelsPerMeter:null,toggleButton:null,showMeasuretoolControl:!0,showConfirmDenyButtons:!0,styleConfirmDenyButtons:!0,returnPixelCoordinates:!0,keyboardShortcut:"d",rect:null,startRotated:!1,startRotatedHeight:.1,startAngle:0,onMeasurementCanceled:null,onMeasurementChanged:null,onMeasurementToggled:null},a),!this.element){this.element=t.makeNeutralElement("div"),this.element.className="measuretool-box";var h=t.makeNeutralElement("div");h.style.position="absolute",h.style.width="100%",h.style.height="0px",h.style.border="1px solid brown",h.style.backgroundColor="brown",h.className="measuretool-box-line",this.element.appendChild(h);var l=t.makeNeutralElement("div");l.style.position="absolute",l.style.color="brown",l.style.fontWeight="bold",l.style.padding="2px",l.style.top="50%",l.style.left="50%",l.style.minWidth="5em",l.style.textAlign="center",l.style.backgroundColor="rgba(255, 255, 255, 0.6)",l.className="measuretool-box-info",this.element.appendChild(l)}for(var d=[],c=0;c<2;c++)d[c]=t.makeNeutralElement("div"),d[c].className="corner-"+c+"-handle",d[c].id="corner-"+c,d[c].style.position="absolute",d[c].style.width="10px",d[c].style.height="10px",d[c].style.background="#000",d[c].style.border="1px solid #ccc",new t.MouseTracker({element:d[c],dragHandler:n.bind(this,c),dragEndHandler:o.bind(this,c)}),setTimeout(this.element.appendChild.bind(this.element,d[c]),0);d[0].style.bottom="-5px",d[0].style.left="-5px",d[1].style.top="-5px",d[1].style.right="-5px",this.overlay||(this.overlay=new t.MeasuretoolOverlay(this.element,this.rect||new t.MeasuretoolRect)),this.outerTracker=new t.MouseTracker({element:this.viewer.canvas,clickTimeThreshold:this.viewer.clickTimeThreshold,clickDistThreshold:this.viewer.clickDistThreshold,dragHandler:t.delegate(this,e),dragEndHandler:t.delegate(this,i),clickHandler:t.delegate(this,r),startDisabled:!this.isMeasuring}),this.keyboardShortcut&&t.addEvent(this.viewer.container,"keypress",t.delegate(this,s),!1);var u=this.viewer.buttons&&this.viewer.buttons.buttons,g=u?this.viewer.buttons.buttons[0]:null,m=g?g.onFocus:null,w=g?g.onBlur:null;if(this.showMeasuretoolControl&&(this.toggleButton=new t.Button({element:this.toggleButton?t.getElement(this.toggleButton):null,clickTimeThreshold:this.viewer.clickTimeThreshold,clickDistThreshold:this.viewer.clickDistThreshold,tooltip:t.getString("Tooltips.MeasuretoolToggle")||"Toggle measuretool",onRelease:this.toggleState.bind(this),onFocus:m,onBlur:w}),u&&(this.viewer.buttons.buttons.push(this.toggleButton),this.viewer.buttons.element.appendChild(this.toggleButton.element)),this.toggleButton.imgDown&&(this.buttonActiveImg=this.toggleButton.imgDown.cloneNode(!0),this.toggleButton.element.appendChild(this.buttonActiveImg))),this.showConfirmDenyButtons){this.cancelButton=new t.Button({element:this.cancelButton?t.getElement(this.cancelButton):null,clickTimeThreshold:this.viewer.clickTimeThreshold,clickDistThreshold:this.viewer.clickDistThreshold,tooltip:t.getString("Tooltips.MeasuretoolConfirm")||"Cancel measuretool",onRelease:this.cancel.bind(this),onFocus:m,onBlur:w});var y=this.cancelButton.element;y.classList.add("cancel-button"),this.element.appendChild(y),this.styleConfirmDenyButtons&&(y.style.position="absolute",y.style.top="50%",y.style.left="50%",y.style.transform="translate(0, -50%)")}this.viewer.addHandler("measurement_cancel",this.onMeasurementCanceled),this.viewer.addHandler("measurement_change",this.onMeasurementChange),this.viewer.addHandler("measurement_toggle",this.onMeasurementToggled),this.viewer.addHandler("open",this.draw.bind(this)),this.viewer.addHandler("animation",this.draw.bind(this)),this.viewer.addHandler("resize",this.draw.bind(this)),this.viewer.addHandler("rotate",this.draw.bind(this))},t.extend(t.Measuretool.prototype,t.ControlDock.prototype,{toggleState:function(){return this.setState(!this.isMeasuring)},setState:function(t){return this.isMeasuring=t,this.viewer.setMouseNavEnabled(!t),this.outerTracker.setTracking(t),t?this.draw():this.undraw(),this.buttonActiveImg&&(this.buttonActiveImg.style.visibility=t?"visible":"hidden"),this.viewer.raiseEvent("measurement_toggle",{enabled:t}),this},enable:function(){return this.setState(!0)},disable:function(){return this.setState(!1)},draw:function(){if(this.rect){var e=this.quadrant,i=this.viewer.viewport.getRotation();if(document.getElementById("corner-0"))switch(e){case 0:document.getElementById("corner-0").style.right="",document.getElementById("corner-1").style.left="",document.getElementById("corner-0").style.left="-5px",document.getElementById("corner-1").style.right="-5px";break;case 1:document.getElementById("corner-0").style.left="",document.getElementById("corner-1").style.right="",document.getElementById("corner-0").style.right="-5px",document.getElementById("corner-1").style.left="-5px";break;case 2:document.getElementById("corner-0").style.right="",document.getElementById("corner-1").style.left="",document.getElementById("corner-0").style.left="-5px",document.getElementById("corner-1").style.right="-5px";break;case 3:document.getElementById("corner-0").style.left="",document.getElementById("corner-1").style.right="",document.getElementById("corner-0").style.right="-5px",document.getElementById("corner-1").style.left="-5px"}var r=this.rect.clone(),n=this.viewer.viewport.viewportToViewerElementRectangle(r);n=t.MeasuretoolRect.fromRect(n),n.rotation=r.rotation,r=n;var o=this.element.children[0],s=Math.sqrt(Math.pow(r.width,2)+Math.pow(r.height,2));this.drawLength(s),o.style.width=s+"px";var a=Math.atan(r.height/r.width)*(180/Math.PI);0===e||2===e?(i>=270?this.startAngle>=270?a=90-a:a-=90:i>=180||i>=90&&(this.startAngle>=90&&this.startAngle<180?a=90-a:a-=90),this.startAngle>=270&&i>=270||this.startAngle>=90&&this.startAngle<180&&i>=90&&i<180?o.style.transform="translateY("+r.width/2+"px) translateX(-"+(s-r.height)/2+"px) rotate(-"+a+"deg)":o.style.transform="translateY("+r.height/2+"px) translateX(-"+(s-r.width)/2+"px) rotate(-"+a+"deg)"):1!==e&&3!==e||(i>=270?(a=90-a,o.style.transform="translateY("+r.width/2+"px) translateX(-"+(s-r.height)/2+"px) rotate("+a+"deg)"):i>=180?o.style.transform="translateY("+r.height/2+"px) translateX(-"+(s-r.width)/2+"px) rotate("+a+"deg)":i>=90?(a=90-a,o.style.transform="translateY("+r.width/2+"px) translateX(-"+(s-r.height)/2+"px) rotate("+a+"deg)"):o.style.transform="translateY("+r.height/2+"px) translateX(-"+(s-r.width)/2+"px) rotate("+a+"deg)"),this.overlay.update(this.rect.normalize()),this.overlay.drawHTML(this.viewer.drawer.container,this.viewer.viewport)}return this.viewer.raiseEvent("measurement_change",this.rect?this.rect.normalize():null),this},undraw:function(){return this.overlay.destroy(),this.rect=null,this},cancel:function(){if(this.rect){var e=this.rect.normalize();if(this.returnPixelCoordinates){var i=this.viewer.viewport.viewportToImageRectangle(e);i=t.MeasuretoolRect.fromRect(i).round(),i.rotation=e.rotation,e=i}this.viewer.raiseEvent("measurement_cancel",e),this.undraw()}return this},drawLength:function(t){var e=this.element.children[1],i=this.viewer.viewport,r=this.viewer.world.getItemAt(0).viewportToImageZoom(i.getZoom(!0)),n=r*this.pixelsPerMeter,o=l(t/n,2,"m");e.innerHTML=o;var s=this.viewer.viewport.getRotation();e.style.transform="rotate(-"+s+"deg)"}})}(OpenSeadragon),function(t){"use strict";t.MeasuretoolOverlay=function(e,i){t.Overlay.apply(this,arguments),t.isPlainObject(e)?this.rotation=e.location.rotation||0:this.rotation=i.rotation||0},t.MeasuretoolOverlay.prototype=t.extend(Object.create(t.Overlay.prototype),{drawHTML:function(){t.Overlay.prototype.drawHTML.apply(this,arguments),this.style.transform=this.style.transform.replace(/ ?rotate\(.+rad\)/,"")+" rotate("+this.rotation+"rad)"},update:function(e){t.Overlay.prototype.update.apply(this,arguments),this.rotation=e.rotation||0}})}(OpenSeadragon),function(t){"use strict";t.MeasuretoolRect=function(e,i,r,n,o){t.Rect.apply(this,[e,i,r,n]),this.rotation=o||0},t.MeasuretoolRect.fromRect=function(e){return new t.MeasuretoolRect(e.x,e.y,e.width,e.height)},t.MeasuretoolRect.prototype=t.extend(Object.create(t.Rect.prototype),{clone:function(){return new t.MeasuretoolRect(this.x,this.y,this.width,this.height,this.rotation)},equals:function(e){return t.Rect.prototype.equals.apply(this,[e])&&this.rotation===e.rotation},toString:function(){return"["+Math.round(100*this.x)/100+","+Math.round(100*this.y)/100+","+Math.round(100*this.width)/100+"x"+Math.round(100*this.height)/100+"@"+Math.round(100*this.rotation)/100+"]"},swapWidthHeight:function(){var t=this.clone();return t.width=this.height,t.height=this.width,t.x+=(this.width-this.height)/2,t.y+=(this.height-this.width)/2,t},getDegreeRotation:function(){return this.rotation*(180/Math.PI)},getAngleFromCenter:function(t){var e=t.minus(this.getCenter());return Math.atan2(e.x,e.y)},round:function(){return new t.MeasuretoolRect(Math.round(this.x),Math.round(this.y),Math.round(this.width),Math.round(this.height),this.rotation)},normalize:function(){var t=this.clone();return t.width<0&&(t.x+=t.width,t.width*=-1),t.height<0&&(t.y+=t.height,t.height*=-1),t.rotation%=Math.PI,t},fitsIn:function(t){for(var e=this.normalize(),i=[e.getTopLeft(),e.getTopRight(),e.getBottomRight(),e.getBottomLeft()],r=e.getCenter(),n=e.getDegreeRotation(),o=t.getBottomRight(),s=0;s<4;s++)if(i[s]=i[s].rotate(n,r),i[s].x<t.x||i[s].x>o.x||i[s].y<t.y||i[s].y>o.y)return!1;return!0},reduceRotation:function(){var t;return this.rotation<Math.PI/-4?(t=this.swapWidthHeight(),t.rotation+=Math.PI/2):this.rotation>Math.PI/4?(t=this.swapWidthHeight(),t.rotation-=Math.PI/2):t=this.clone(),t}})}(OpenSeadragon);
//# sourceMappingURL=openseadragon-measuretool.min.js.map
